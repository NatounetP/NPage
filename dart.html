<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dart Score Tracker V3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 10px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* Wake Lock Button */
        .app-mode-toggle {
            position: fixed;
            top: 30px;
            right: 15px;
            background: #4dabf7;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .app-mode-toggle:hover {
            transform: scale(1.1);
        }

        .app-mode-toggle.active {
            background: #20c997;
        }

        /* Fullscreen mode styles */
        body.fullscreen-mode {
            padding: 0 !important;
            background: #1a1a2e !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            overflow: hidden !important;
        }

        .fullscreen-mode .container {
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            max-width: none !important;
        }

        .fullscreen-mode .config-screen {
            height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .fullscreen-mode .game-screen.active {
            height: 100vh !important;
            display: flex !important;
            flex-direction: column;
        }

        .fullscreen-mode .game-header {
            border-radius: 0 !important;
            margin-bottom: 10px !important;
        }

        .fullscreen-mode .scoreboard-501,
        .fullscreen-mode .scoreboard-cricket {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px !important;
        }

        .fullscreen-mode .game-controls {
            margin-top: 10px !important;
            padding: 10px !important;
        }

        /* Exit app mode button */
        .exit-app-mode-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(248, 150, 30, 0.9);
            color: white;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            display: none;
            font-weight: 500;
        }

        .fullscreen-mode .exit-app-mode-btn {
            display: block;
        }

        .exit-app-mode-btn:hover {
            background-color: rgba(248, 150, 30, 1);
            transform: scale(1.05);
        }

        .exit-app-mode-btn:active {
            transform: scale(0.95);
        }

        /* App mode notification */
        .app-mode-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            display: none;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }

        .app-mode-notification.info {
            background-color: #4dabf7;
        }

        .app-mode-notification.error {
            background-color: #ff6b6b;
        }

        .app-mode-notification.success {
            background-color: #20c997;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Configuration Screen */
        .config-screen {
            background: #16213e;
            border-radius: 10px;
            padding: 25px;
            max-width: 500px;
            margin: 30px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .config-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: #FFD700;
            text-align: center;
        }

        .game-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .game-btn {
            padding: 20px;
            background: #0f3460;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .game-btn:hover {
            background: #1a3a6e;
            transform: translateY(-2px);
        }

        .game-btn.selected {
            background: #4dabf7;
            border: 3px solid white;
        }

        .player-config {
            margin-bottom: 30px;
        }

        .player-config h3 {
            color: #4dabf7;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .player-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-input {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4dabf7;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
        }

        .remove-player {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.3rem;
        }

        .add-player {
            background: #20c997;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 10px;
        }

        .start-btn {
            background: #4dabf7;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .start-btn:hover {
            background: #339af0;
        }

        /* Game Screens */
        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        /* Game Header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #16213e;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
        }

        .game-header-controls {
            display: flex;
            gap: 10px;
        }

        .settings-btn {
            background: #4dabf7;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
			margin-right: 60px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            transform: scale(1.1);
        }

        /* ===== 501 GAME - OPTIMISÉ POUR MOBILE ===== */
        .scoreboard-501 {
            background: #0f3460;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Grille des joueurs pour mobile */
        .players-score-501 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .player-card-501 {
            background: #16213e;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .player-card-501.selected {
            border-color: #4dabf7;
            background: #1a3a6e;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(77, 171, 247, 0.5);
        }

        .player-card-501.selected::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #20c997;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .player-name-501 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
        }

        .player-score-501 {
            font-size: 2rem;
            font-weight: bold;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 5px;
            border-radius: 8px;
            margin: 8px 0;
            border: 2px solid #4dabf7;
        }

        .player-score-501.low {
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }

        .player-score-501.win {
            background: #20c997;
            animation: pulse 0.5s infinite;
        }

        .player-legs-set-mini {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 8px;
        }

        .player-legs-set-mini span {
            font-weight: bold;
            color: white;
            margin-left: 5px;
        }

        /* Section d'input des scores - SANS BOUTONS PRÉDÉFINIS */
        .score-input-section {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid rgba(77, 171, 247, 0.3);
        }

        .current-player-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f3460;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .current-player-label {
            font-size: 1rem;
            color: #4dabf7;
        }

        .current-player-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #FFD700;
        }

        .score-input {
            width: 100%;
            padding: 12px;
            font-size: 2rem;
            text-align: center;
            border-radius: 8px;
            border: 3px solid #4dabf7;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            margin-bottom: 15px;
        }

        .add-score-btn {
            background: #20c997;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 49%;
        }

        .skip-turn-btn {
            background: #4dabf7;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 49%;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ===== CRICKET GAME - NOUVEAU SYSTÈME DE MARQUES ===== */
        .scoreboard-cricket {
            background: #0f3460;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .cricket-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }

        .cricket-table th {
            background: #16213e;
            padding: 10px 5px;
            text-align: center;
            font-size: 0.9rem;
            border-bottom: 2px solid #4dabf7;
            cursor: pointer;
        }

        .cricket-table th.active {
            background: #4dabf7;
            color: white;
        }

        .cricket-table td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .number-cell {
            background: #16213e;
            font-weight: bold;
            font-size: 1rem;
            width: 50px;
        }

        .player-score-cell {
            font-size: 1rem;
            font-weight: bold;
            color: #FFD700;
        }

        .mark-cell {
            height: 50px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mark-cell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mark-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 100%;
        }

        .marks-row {
            display: flex;
            justify-content: center;
            gap: 3px;
        }

        .mark {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .mark.filled {
            background: #20c997;
            color: white;
        }

        .mark.closed {
            background: #4dabf7;
            color: white;
        }

        .mark.points {
            background: #ff6b6b;
            color: white;
        }

        .points-indicator {
            font-size: 0.9rem;
            color: #ff6b6b;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .points-indicator i {
            font-size: 0.8rem;
        }

        /* Game Controls */
        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .undo-btn {
            background: #ff922b;
            color: white;
        }

        .new-game-btn {
            background: #ff6b6b;
            color: white;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: #16213e;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
        }

        .settings-title {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 25px;
            text-align: center;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 10px;
            color: #4dabf7;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .settings-input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4dabf7;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
        }

        .settings-btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .save-settings, .cancel-settings {
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            flex: 1;
            font-size: 1.1rem;
        }

        .save-settings {
            background: #20c997;
            color: white;
        }

        .cancel-settings {
            background: #6c757d;
            color: white;
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-mode-toggle {
                width: 45px;
                height: 45px;
                top: 10px;
                right: 10px;
            }
            
            .players-score-501 {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .player-name-501 {
                font-size: 1rem;
            }
            
            .player-score-501 {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 480px) {
            .players-score-501 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .player-name-501 {
                font-size: 0.9rem;
            }
            
            .player-score-501 {
                font-size: 1.4rem;
            }
            
            .mark {
                width: 16px;
                height: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- App Mode Toggle Button -->
    <button class="app-mode-toggle" id="app-mode-toggle" title="Mode App (plein écran + verrouillage écran)">
        <i class="fas fa-moon"></i>
    </button>
    
    <!-- Exit App Mode Button -->
    <button class="exit-app-mode-btn" id="exit-app-mode-btn" title="Quitter le mode App">
        <i class="fas fa-times"></i> Quitter
    </button>

    <div class="container">
        <!-- Configuration Screen -->
        <div class="config-screen" id="config-screen">
            <h1 class="config-title">Dart Score V3</h1>
            
            <div class="game-selection">
                <button class="game-btn selected" id="game-501-btn">
                    <i class="fas fa-bullseye"></i> 501 / 301
                </button>
                <button class="game-btn" id="game-cricket-btn">
                    <i class="fas fa-cricket"></i> Cricket
                </button>
            </div>
            
            <div class="player-config">
                <h3>Joueurs</h3>
                <div class="player-inputs" id="player-inputs">
                    <div class="player-input-row">
                        <input type="text" class="player-input" placeholder="Joueur 1" value="Joueur 1">
                        <button class="remove-player hidden">×</button>
                    </div>
                    <div class="player-input-row">
                        <input type="text" class="player-input" placeholder="Joueur 2" value="Joueur 2">
                        <button class="remove-player hidden">×</button>
                    </div>
                </div>
                <button class="add-player" id="add-player">
                    <i class="fas fa-plus"></i> Ajouter un joueur
                </button>
            </div>
            
            <button class="start-btn" id="start-game">
                <i class="fas fa-play"></i> Commencer
            </button>
        </div>

        <!-- 501 Game Screen - Sans boutons prédéfinis -->
        <div class="game-screen" id="game-screen-501">
            <div class="game-header">
                <div class="game-title" id="game-title-501">501</div>
                <div class="game-header-controls">
                    <button class="settings-btn" id="settings-btn-501">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="scoreboard-501">
                <!-- Grille des joueurs avec scores -->
                <div class="players-score-501" id="players-score-container">
                    <!-- Les cartes joueurs seront ajoutées dynamiquement -->
                </div>
                
                <!-- Section de saisie des scores - SANS BOUTONS PRÉDÉFINIS -->
                <div class="score-input-section">
                    
                    <input type="number" class="score-input" id="score-input-501" placeholder="Score" value="" min="0" max="180" inputmode="numeric">
                    <div class="current-player-indicator">
                        <span class="current-player-label">Joueur sélectionné :</span>
                        <span class="current-player-value" id="current-player-name">Joueur 1</span>
                    </div>
                    <button class="add-score-btn" id="add-score-501">
                        <i class="fas fa-plus"></i> Ajouter le score
                    </button>
                    
                    <button class="skip-turn-btn" id="next-player-501">
                        <i class="fas fa-forward"></i> Passer le tour
                    </button>
                </div>
            </div>
            
            <div class="game-controls">
                <button class="control-btn undo-btn" id="undo-501">
                    <i class="fas fa-undo"></i> Annuler
                </button>
                <button class="control-btn new-game-btn" id="new-game-501">
                    <i class="fas fa-redo"></i> Nouvelle partie
                </button>
            </div>
        </div>

        <!-- Cricket Game Screen - Nouveau système X pour fermer, I pour points -->
        <div class="game-screen" id="game-screen-cricket">
            <div class="game-header">
                <div class="game-title" id="game-title-cricket">Cricket</div>
                <div class="game-header-controls">
                    <button class="settings-btn" id="settings-btn-cricket">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="scoreboard-cricket">
                <table class="cricket-table">
                    <thead>
                        <tr id="cricket-header-row">
                            <th></th>
                            <!-- Player headers will be added here -->
                        </tr>
                    </thead>
                    <tbody id="cricket-table-body">
                        <!-- Cricket table rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="game-controls">
                <button class="control-btn undo-btn" id="undo-cricket">
                    <i class="fas fa-undo"></i> Annuler
                </button>
                <button class="control-btn new-game-btn" id="new-game-cricket">
                    <i class="fas fa-redo"></i> Nouvelle partie
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <h2 class="settings-title">Paramètres</h2>
            
            <div class="settings-group">
                <label class="settings-label" for="starting-score">Score de départ</label>
                <select class="settings-input" id="starting-score">
                    <option value="501">501</option>
                    <option value="301">301</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label class="settings-label" for="legs-to-win-set">Legs pour gagner un set</label>
                <input type="number" class="settings-input" id="legs-to-win-set" min="1" max="10" value="1">
            </div>
            
            <div class="settings-group">
                <label class="settings-label" for="sets-to-win-game">Sets pour gagner</label>
                <input type="number" class="settings-input" id="sets-to-win-game" min="1" max="10" value="1">
            </div>
            
            <div class="settings-btn-group">
                <button class="save-settings" id="save-settings">
                    <i class="fas fa-check"></i> Sauvegarder
                </button>
                <button class="cancel-settings" id="cancel-settings">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            gameType: '501',
            players: [],
            currentPlayerIndex: 0,
            selectedPlayerId: null, // Pour le mode 501 avec sélection libre
            settings: {
                startingScore: 501,
                legsToWinSet: 1,
                setsToWinGame: 1
            },
            history: [],
            cricketState: {
                currentPlayerId: null,
                numbers: [20, 19, 18, 17, 16, 15, 25],
                closedNumbers: {},
                pointsHistory: [] // Pour suivre qui a donné des points à qui
            }
        };

        // App mode state
        let isAppModeActive = false;
        let wakeLock = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupConfiguration();
            setupEventListeners();
            setupAppMode();
            
            // Visual feedback for buttons
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
            
            // Fullscreen change listener
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        });

        // ==================== APP MODE FUNCTIONS ====================
        function setupAppMode() {
            const appModeToggle = document.getElementById('app-mode-toggle');
            const exitAppModeBtn = document.getElementById('exit-app-mode-btn');
            
            updateAppModeUI();
            
            appModeToggle.addEventListener('click', toggleAppMode);
            appModeToggle.addEventListener('touchstart', function(e) {
                e.preventDefault();
                toggleAppMode();
            });
            
            exitAppModeBtn.addEventListener('click', disableAppMode);
            exitAppModeBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                disableAppMode();
            });
            
            document.addEventListener('visibilitychange', async () => {
                if (isAppModeActive && document.visibilityState === 'visible') {
                    try {
                        await acquireWakeLock();
                    } catch (err) {
                        console.warn('Failed to reacquire wake lock:', err);
                    }
                }
            });
        }

        async function toggleAppMode() {
            if (isAppModeActive) {
                await disableAppMode();
            } else {
                await enableAppMode();
            }
        }

        async function enableAppMode() {
            try {
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    await document.documentElement.webkitRequestFullscreen();
                }
                
                document.body.classList.add('fullscreen-mode');
                await acquireWakeLock();
                isAppModeActive = true;
                updateAppModeUI();
                showAppModeNotification('Mode App activé', 'success');
            } catch (error) {
                console.error('Error enabling app mode:', error);
                showAppModeNotification('Échec d\'activation du mode App', 'error');
            }
        }

        async function disableAppMode() {
            try {
                if (document.fullscreenElement && document.exitFullscreen) {
                    await document.exitFullscreen();
                } else if (document.webkitFullscreenElement && document.webkitExitFullscreen) {
                    await document.webkitExitFullscreen();
                }
                
                document.body.classList.remove('fullscreen-mode');
                await releaseWakeLock();
                isAppModeActive = false;
                updateAppModeUI();
                showAppModeNotification('Mode App désactivé', 'info');
            } catch (error) {
                console.error('Error disabling app mode:', error);
            }
        }

        function handleFullscreenChange() {
            const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            
            if (!isCurrentlyFullscreen && isAppModeActive) {
                isAppModeActive = false;
                document.body.classList.remove('fullscreen-mode');
                
                if (wakeLock) {
                    wakeLock.release().then(() => {
                        wakeLock = null;
                    });
                }
                
                updateAppModeUI();
                showAppModeNotification('Mode App désactivé', 'info');
            }
        }

        async function acquireWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    
                    wakeLock.addEventListener('release', () => {
                        wakeLock = null;
                        if (isAppModeActive && document.visibilityState === 'visible') {
                            setTimeout(() => {
                                acquireWakeLock().catch(err => {
                                    console.error('Failed to reacquire wake lock:', err);
                                });
                            }, 1000);
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to acquire wake lock:', err);
                throw err;
            }
        }

        async function releaseWakeLock() {
            try {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                }
            } catch (err) {
                console.error('Failed to release wake lock:', err);
            }
        }

        function updateAppModeUI() {
            const appModeToggle = document.getElementById('app-mode-toggle');
            
            if (isAppModeActive) {
                appModeToggle.classList.add('active');
                appModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                appModeToggle.title = 'Mode App actif - cliquer pour désactiver';
            } else {
                appModeToggle.classList.remove('active');
                appModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                appModeToggle.title = 'Mode App inactif - cliquer pour activer';
            }
        }

        function showAppModeNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.app-mode-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `app-mode-notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.display = 'block';
            }, 10);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }

        // ==================== CONFIGURATION ====================
        function setupConfiguration() {
            const game501Btn = document.getElementById('game-501-btn');
            const gameCricketBtn = document.getElementById('game-cricket-btn');
            
            game501Btn.addEventListener('click', function() {
                game501Btn.classList.add('selected');
                gameCricketBtn.classList.remove('selected');
                gameState.gameType = '501';
            });
            
            gameCricketBtn.addEventListener('click', function() {
                gameCricketBtn.classList.add('selected');
                game501Btn.classList.remove('selected');
                gameState.gameType = 'cricket';
            });
            
            document.getElementById('add-player').addEventListener('click', function() {
                const playerInputs = document.getElementById('player-inputs');
                const playerCount = playerInputs.children.length + 1;
                
                const playerRow = document.createElement('div');
                playerRow.className = 'player-input-row';
                playerRow.innerHTML = `
                    <input type="text" class="player-input" placeholder="Joueur ${playerCount}" value="Joueur ${playerCount}">
                    <button class="remove-player">×</button>
                `;
                
                playerInputs.appendChild(playerRow);
                
                if (playerInputs.children.length > 2) {
                    document.querySelectorAll('.remove-player').forEach(btn => {
                        btn.classList.remove('hidden');
                    });
                }
            });
            
            document.getElementById('player-inputs').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-player')) {
                    const playerRow = e.target.parentElement;
                    playerRow.remove();
                    
                    if (document.querySelectorAll('.player-input-row').length <= 2) {
                        document.querySelectorAll('.remove-player').forEach(btn => {
                            btn.classList.add('hidden');
                        });
                    }
                }
            });
            
            document.getElementById('start-game').addEventListener('click', startGame);
        }

        // ==================== GAME START ====================
        function startGame() {
            const playerInputs = document.querySelectorAll('.player-input');
            gameState.players = [];
            
            playerInputs.forEach((input, index) => {
                const playerName = input.value || `Joueur ${index + 1}`;
                const startingScore = gameState.gameType === 'cricket' ? 0 : gameState.settings.startingScore;
                
                gameState.players.push({
                    id: index + 1,
                    name: playerName,
                    score: startingScore,
                    history: [],
                    legs: 0,
                    sets: 0,
                    cricketMarks: {
                        20: { marks: 0, points: [] },
                        19: { marks: 0, points: [] },
                        18: { marks: 0, points: [] },
                        17: { marks: 0, points: [] },
                        16: { marks: 0, points: [] },
                        15: { marks: 0, points: [] },
                        25: { marks: 0, points: [] }
                    },
                    cricketPoints: 0,
                    currentRoundScore: 0,
                    dartsThisRound: 0
                });
            });
            
            gameState.currentPlayerIndex = 0;
            gameState.selectedPlayerId = gameState.players[0]?.id || null;
            gameState.history = [];
            gameState.cricketState.currentPlayerId = gameState.players[0]?.id || null;
            gameState.cricketState.closedNumbers = {};
            gameState.cricketState.pointsHistory = [];
            
            document.getElementById('config-screen').classList.add('hidden');
            
            if (gameState.gameType === 'cricket') {
                document.getElementById('game-screen-501').classList.remove('active');
                document.getElementById('game-screen-cricket').classList.add('active');
                setupCricketGame();
            } else {
                document.getElementById('game-screen-cricket').classList.remove('active');
                document.getElementById('game-screen-501').classList.add('active');
                setup501Game();
            }
        }

        // ==================== 501 GAME - SANS BOUTONS PRÉDÉFINIS ====================
        function setup501Game() {
            const gameTitle = document.getElementById('game-title-501');
            gameTitle.textContent = gameState.settings.startingScore;
            
            // Mise à jour de la grille des joueurs
            const playersContainer = document.getElementById('players-score-container');
            playersContainer.innerHTML = '';
            
            gameState.players.forEach((player) => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card-501 ${player.id === gameState.selectedPlayerId ? 'selected' : ''}`;
                playerCard.id = `player-card-${player.id}`;
                playerCard.dataset.playerId = player.id;
                
                // Créer la carte joueur
                const playerName = document.createElement('div');
                playerName.className = 'player-name-501';
                playerName.textContent = player.name;
                
                const playerScore = document.createElement('div');
                playerScore.className = `player-score-501 ${player.score <= 40 ? 'low' : ''} ${player.score === 0 ? 'win' : ''}`;
                playerScore.id = `player-score-display-${player.id}`;
                playerScore.textContent = player.score;
                
                const legsSetMini = document.createElement('div');
                legsSetMini.className = 'player-legs-set-mini';
                legsSetMini.innerHTML = `
                    <span>Legs: <span id="player-legs-${player.id}">${player.legs}</span></span>
                    <span>Sets: <span id="player-sets-${player.id}">${player.sets}</span></span>
                `;
                
                playerCard.appendChild(playerName);
				playerCard.appendChild(legsSetMini);
                playerCard.appendChild(playerScore);
                
                
                // Ajouter l'événement de sélection
                playerCard.addEventListener('click', () => selectPlayer501(player.id));
                playerCard.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    selectPlayer501(player.id);
                });
                
                playersContainer.appendChild(playerCard);
            });
            
            // Mettre à jour l'affichage du joueur sélectionné
            const selectedPlayer = gameState.players.find(p => p.id === gameState.selectedPlayerId) || gameState.players[0];
            if (selectedPlayer) {
                document.getElementById('current-player-name').textContent = selectedPlayer.name;
            }
            
            // Focus sur l'input
            document.getElementById('score-input-501').focus();
        }

        function selectPlayer501(playerId) {
            gameState.selectedPlayerId = playerId;
            
            // Mettre à jour l'affichage des cartes
            document.querySelectorAll('.player-card-501').forEach(card => {
                const cardPlayerId = parseInt(card.dataset.playerId);
                if (cardPlayerId === playerId) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Mettre à jour le nom du joueur sélectionné
            const player = gameState.players.find(p => p.id === playerId);
            if (player) {
                document.getElementById('current-player-name').textContent = player.name;
            }
        }

        function addScore501() {
            const scoreInput = document.getElementById('score-input-501');
            const score = parseInt(scoreInput.value) || 0;
            
            if (score < 0 || score > 180) {
                alert('Veuillez entrer un score entre 0 et 180');
                return;
            }
            
            // Utiliser le joueur sélectionné (pas forcément le joueur courant)
            const selectedPlayer = gameState.players.find(p => p.id === gameState.selectedPlayerId);
            if (!selectedPlayer) return;
            
            const newScore = selectedPlayer.score - score;
            
            // Enregistrer dans l'historique
            gameState.history.push({
                playerId: selectedPlayer.id,
                action: 'score',
                value: score,
                previousScore: selectedPlayer.score,
                newScore: newScore,
                timestamp: new Date().getTime()
            });
            
            // Vérifier les règles de bust et de fin
            if (newScore === 0) {
                // Vérifier si c'est une fin valide (double ou bull)
                if (confirm(`${selectedPlayer.name} a terminé avec ${score} points. Le dernier tir était-il un double ou un bull? (OK pour Oui, Annuler pour Non)`)) {
                    // Victoire valide
                    selectedPlayer.score = 0;
                    selectedPlayer.history.push(`WIN (${score})`);
                    
                    // Gagner la leg
                    selectedPlayer.legs++;
                    
                    // Vérifier la victoire du set
                    if (selectedPlayer.legs >= gameState.settings.legsToWinSet) {
                        selectedPlayer.sets++;
                        selectedPlayer.legs = 0;
                        
                        if (selectedPlayer.sets >= gameState.settings.setsToWinGame) {
                            alert(`${selectedPlayer.name} remporte la partie !`);
                            resetGame();
                            return;
                        } else {
                            alert(`${selectedPlayer.name} remporte le set ! Nouveau set.`);
                            // Réinitialiser les scores pour le nouveau set
                            gameState.players.forEach(p => {
                                p.score = gameState.settings.startingScore;
                                p.history = [];
                            });
                        }
                    } else {
                        alert(`${selectedPlayer.name} remporte la leg !`);
                        // Réinitialiser les scores pour la nouvelle leg
                        gameState.players.forEach(p => {
                            p.score = gameState.settings.startingScore;
                            p.history = [];
                        });
                    }
                } else {
                    // Bust - le score reste inchangé
                    selectedPlayer.history.push(`BUST (${score})`);
                }
            } else if (newScore < 0 || newScore === 1) {
                // Bust
                selectedPlayer.history.push(`BUST (${score})`);
            } else {
                // Score valide
                selectedPlayer.score = newScore;
                selectedPlayer.history.push(score);
            }
            
            // Mettre à jour l'affichage
            setup501Game();
            nextPlayer501();
            // Réinitialiser l'input
            scoreInput.value = '';
            scoreInput.focus();
        }

        function nextPlayer501() {
            // Passer au joueur suivant dans l'ordre
            if (gameState.players.length > 0) {
                const currentIndex = gameState.players.findIndex(p => p.id === gameState.selectedPlayerId);
                const nextIndex = (currentIndex + 1) % gameState.players.length;
                gameState.selectedPlayerId = gameState.players[nextIndex].id;
                setup501Game();
            }
        }

        // ==================== CRICKET GAME - X POUR FERMER, I POUR POINTS ====================
        function setupCricketGame() {
            const headerRow = document.getElementById('cricket-header-row');
            headerRow.innerHTML = '<th></th>';
            
            gameState.players.forEach(player => {
                const th = document.createElement('th');
                th.className = `player-header-cell ${player.id === gameState.cricketState.currentPlayerId ? 'active' : ''}`;
                th.textContent = player.name;
                th.dataset.playerId = player.id;
                
                th.addEventListener('click', () => selectCricketPlayer(player.id));
                th.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    selectCricketPlayer(player.id);
                });
                
                headerRow.appendChild(th);
            });
            
            const tableBody = document.getElementById('cricket-table-body');
            tableBody.innerHTML = '';
            
            // Points row (total des points)
            const pointsRow = document.createElement('tr');
            const pointsLabel = document.createElement('td');
            pointsLabel.className = 'number-cell';
            pointsLabel.textContent = 'Pts';
            pointsRow.appendChild(pointsLabel);
            
            gameState.players.forEach(player => {
                const td = document.createElement('td');
                td.className = 'player-score-cell';
                td.textContent = player.cricketPoints;
                pointsRow.appendChild(td);
            });
            
            tableBody.appendChild(pointsRow);
            
            // Number rows
            gameState.cricketState.numbers.forEach(number => {
                const row = document.createElement('tr');
                
                const numberCell = document.createElement('td');
                numberCell.className = 'number-cell';
                numberCell.textContent = number === 25 ? 'Bull' : number;
                row.appendChild(numberCell);
                
                gameState.players.forEach(player => {
                    const td = document.createElement('td');
                    td.className = 'mark-cell';
                    td.dataset.playerId = player.id;
                    td.dataset.number = number;
                    
                    const markData = player.cricketMarks[number] || { marks: 0, points: [] };
                    
                    const markDisplay = document.createElement('div');
                    markDisplay.className = 'mark-display';
                    
                    // Première ligne : les X pour fermer le numéro (max 3)
                    const marksRow = document.createElement('div');
                    marksRow.className = 'marks-row';
                    
                    for (let i = 0; i < 3; i++) {
                        const mark = document.createElement('div');
                        mark.className = 'mark';
                        if (i < markData.marks) {
                            mark.classList.add('filled');
                            mark.textContent = 'X';
                        }
                        marksRow.appendChild(mark);
                    }
                    
                    markDisplay.appendChild(marksRow);
                    
                    // Deuxième ligne : les I pour les points marqués (uniquement si le numéro est fermé par ce joueur)
                    if (markData.marks >= 0 && markData.points && markData.points.length > 0) {
                        const pointsRow = document.createElement('div');
                        pointsRow.className = 'points-indicator';
                        
                        // Afficher le nombre de points avec des I
                        const pointsCount = markData.points.length;
                        for (let i = 0; i < pointsCount; i++) {
                            const pointMark = document.createElement('span');
                            pointMark.innerHTML = 'I';
                            pointMark.style.color = '#ff6b6b';
                            pointMark.style.fontWeight = 'bold';
                            pointMark.style.marginRight = '2px';
                            pointsRow.appendChild(pointMark);
                        }
                        
                        markDisplay.appendChild(pointsRow);
                    }
                    
                    td.appendChild(markDisplay);
                    
                    td.addEventListener('click', function() {
                        if (gameState.cricketState.currentPlayerId === player.id) {
                            addCricketMark(player.id, number);
                        }
                    });
                    td.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        if (gameState.cricketState.currentPlayerId === player.id) {
                            addCricketMark(player.id, number);
                        }
                    });
                    
                    row.appendChild(td);
                });
                
                tableBody.appendChild(row);
            });
        }

        function selectCricketPlayer(playerId) {
            gameState.cricketState.currentPlayerId = playerId;
            setupCricketGame();
        }

        function addCricketMark(playerId, number) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            
            const markData = player.cricketMarks[number];
            const hasClosedNumber = markData.marks >= 3;
            
            if (hasClosedNumber) {
                // Le numéro est déjà fermé par ce joueur
                // Il donne des points à tous ceux qui n'ont pas fermé ce numéro
                gameState.players.forEach(otherPlayer => {
                    if (otherPlayer.id !== playerId) {
                        const otherMarkData = otherPlayer.cricketMarks[number];
                        
                        if (otherMarkData.marks < 3) {
                            // Ce joueur n'a pas fermé le numéro - il reçoit des points
                            const pointsToAdd = (number === 25 ? 25 : number);
                            
                            // Ajouter des points au total du joueur
                            otherPlayer.cricketPoints += pointsToAdd;
                            
                            // Enregistrer que ce joueur a reçu des points sur ce numéro
                            if (!otherMarkData.points) {
                                otherMarkData.points = [];
                            }
                            
                            // Ajouter une entrée pour ce point reçu
                            otherMarkData.points.push({
                                from: playerId,
                                value: pointsToAdd,
                                timestamp: new Date().getTime()
                            });
                            
                            gameState.history.push({
                                playerId: otherPlayer.id,
                                action: 'cricket-points-received',
                                fromPlayer: playerId,
                                number: number,
                                points: pointsToAdd,
                                timestamp: new Date().getTime()
                            });
                        }
                    }
                });
                
                gameState.history.push({
                    playerId: playerId,
                    action: 'cricket-hit-closed',
                    number: number,
                    timestamp: new Date().getTime()
                });
            } else {
                // Le joueur n'a pas encore fermé ce numéro - ajouter un X
                markData.marks++;
                
                if (markData.marks === 3) {
                    gameState.cricketState.closedNumbers[number] = playerId;
                    
                    gameState.history.push({
                        playerId: playerId,
                        action: 'cricket-close',
                        number: number,
                        timestamp: new Date().getTime()
                    });
                }
                
                gameState.history.push({
                    playerId: playerId,
                    action: 'cricket-mark',
                    number: number,
                    marks: markData.marks,
                    timestamp: new Date().getTime()
                });
            }
            
            setupCricketGame();
            checkCricketWin();
        }

        function checkCricketWin() {
            gameState.players.forEach(player => {
                let allClosed = true;
                gameState.cricketState.numbers.forEach(number => {
                    if (player.cricketMarks[number].marks < 3) {
                        allClosed = false;
                    }
                });
                
                if (allClosed) {
                    let hasLowestScore = true;
                    gameState.players.forEach(otherPlayer => {
                        if (otherPlayer.id !== player.id && player.cricketPoints > otherPlayer.cricketPoints) {
                            hasLowestScore = false;
                        }
                    });
                    
                    if (hasLowestScore) {
                        setTimeout(() => {
                            alert(`${player.name} remporte la partie de cricket !`);
                            resetGame();
                        }, 500);
                    }
                }
            });
        }

        // ==================== UNDO FUNCTION ====================
        function undoLast() {
            if (gameState.history.length === 0) return;
            
            const lastAction = gameState.history.pop();
            
            if (gameState.gameType === '501') {
                const player = gameState.players.find(p => p.id === lastAction.playerId);
                if (player && lastAction.action === 'score') {
                    player.score = lastAction.previousScore;
                    if (player.history.length > 0) {
                        player.history.pop();
                    }
                    setup501Game();
                }
            } else if (gameState.gameType === 'cricket') {
                const player = gameState.players.find(p => p.id === lastAction.playerId);
                if (player) {
                    switch (lastAction.action) {
                        case 'cricket-mark':
                            if (player.cricketMarks[lastAction.number].marks > 0) {
                                player.cricketMarks[lastAction.number].marks--;
                                if (player.cricketMarks[lastAction.number].marks === 2) {
                                    delete gameState.cricketState.closedNumbers[lastAction.number];
                                }
                            }
                            break;
                        case 'cricket-close':
                            player.cricketMarks[lastAction.number].marks = 2;
                            delete gameState.cricketState.closedNumbers[lastAction.number];
                            break;
                        case 'cricket-points-received':
                            const receiver = gameState.players.find(p => p.id === lastAction.playerId);
                            if (receiver) {
                                receiver.cricketPoints -= lastAction.points;
                                // Retirer le dernier point reçu de l'historique des points
                                const pointsArray = receiver.cricketMarks[lastAction.number].points;
                                if (pointsArray && pointsArray.length > 0) {
                                    pointsArray.pop();
                                }
                            }
                            break;
                    }
                    setupCricketGame();
                }
            }
        }

        // ==================== RESET GAME ====================
        function resetGame() {
            gameState.players = [];
            gameState.history = [];
            gameState.currentPlayerIndex = 0;
            gameState.selectedPlayerId = null;
            gameState.cricketState.closedNumbers = {};
            gameState.cricketState.pointsHistory = [];
            
            document.getElementById('game-screen-501').classList.remove('active');
            document.getElementById('game-screen-cricket').classList.remove('active');
            document.getElementById('config-screen').classList.remove('hidden');
        }

        // ==================== SETTINGS ====================
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            
            document.getElementById('starting-score').value = gameState.settings.startingScore;
            document.getElementById('legs-to-win-set').value = gameState.settings.legsToWinSet;
            document.getElementById('sets-to-win-game').value = gameState.settings.setsToWinGame;
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            gameState.settings.startingScore = parseInt(document.getElementById('starting-score').value);
            gameState.settings.legsToWinSet = parseInt(document.getElementById('legs-to-win-set').value);
            gameState.settings.setsToWinGame = parseInt(document.getElementById('sets-to-win-game').value);
            
            if (gameState.gameType === '501') {
                document.getElementById('game-title-501').textContent = gameState.settings.startingScore;
                
                if (gameState.players.length > 0) {
                    const isNewSet = confirm("Changer les paramètres va réinitialiser la partie. Continuer?");
                    if (isNewSet) {
                        resetGame();
                    } else {
                        closeSettings();
                        return;
                    }
                }
            }
            
            closeSettings();
            startGame();
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // 501 game events
            document.getElementById('add-score-501').addEventListener('click', addScore501);
            document.getElementById('score-input-501').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addScore501();
                }
            });
            
            document.getElementById('undo-501').addEventListener('click', undoLast);
            document.getElementById('next-player-501').addEventListener('click', nextPlayer501);
            document.getElementById('new-game-501').addEventListener('click', resetGame);
            document.getElementById('settings-btn-501').addEventListener('click', openSettings);
            
            // Cricket game events
            document.getElementById('undo-cricket').addEventListener('click', undoLast);
            document.getElementById('new-game-cricket').addEventListener('click', resetGame);
            document.getElementById('settings-btn-cricket').addEventListener('click', openSettings);
            
            // Settings modal events
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('cancel-settings').addEventListener('click', closeSettings);
            
            document.getElementById('settings-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        }
    </script>
</body>
</html>