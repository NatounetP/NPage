<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dart Score Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 10px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* Wake Lock Button - Updated for app mode */
        .app-mode-toggle {
            position: fixed;
            top: 90px;
            right: 15px;
            background: #4dabf7;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .app-mode-toggle:hover {
            transform: scale(1.1);
        }

        .app-mode-toggle.active {
            background: #20c997;
        }

        /* Fullscreen mode styles */
        body.fullscreen-mode {
            padding: 0 !important;
            background: #1a1a2e !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            overflow: hidden !important;
        }

        .fullscreen-mode .container {
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            max-width: none !important;
        }

        .fullscreen-mode .config-screen {
            height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .fullscreen-mode .game-screen.active {
            height: 100vh !important;
            display: flex !important;
            flex-direction: column;
        }

        .fullscreen-mode .game-header {
            border-radius: 0 !important;
            margin-bottom: 10px !important;
        }

        .fullscreen-mode .scoreboard-501,
        .fullscreen-mode .scoreboard-cricket {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px !important;
        }

        .fullscreen-mode .game-controls {
            margin-top: 10px !important;
            padding: 10px !important;
        }

        /* App mode exit button */
        .exit-app-mode-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(248, 150, 30, 0.9);
            color: white;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            display: none;
            font-weight: 500;
        }

        .fullscreen-mode .exit-app-mode-btn {
            display: block;
        }

        .exit-app-mode-btn:hover {
            background-color: rgba(248, 150, 30, 1);
            transform: scale(1.05);
        }

        .exit-app-mode-btn:active {
            transform: scale(0.95);
        }

        /* App mode notification */
        .app-mode-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            display: none;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }

        .app-mode-notification.info {
            background-color: #4dabf7;
        }

        .app-mode-notification.error {
            background-color: #ff6b6b;
        }

        .app-mode-notification.success {
            background-color: #20c997;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Configuration Screen */
        .config-screen {
            background: #16213e;
            border-radius: 10px;
            padding: 25px;
            max-width: 500px;
            margin: 30px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .config-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: #FFD700;
            text-align: center;
        }

        .game-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .game-btn {
            padding: 20px;
            background: #0f3460;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .game-btn:hover {
            background: #1a3a6e;
            transform: translateY(-2px);
        }

        .game-btn.selected {
            background: #4dabf7;
            border: 3px solid white;
        }

        .player-config {
            margin-bottom: 30px;
        }

        .player-config h3 {
            color: #4dabf7;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .player-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-input {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4dabf7;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
        }

        .remove-player {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.3rem;
        }

        .add-player {
            background: #20c997;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 10px;
        }

        .start-btn {
            background: #4dabf7;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .start-btn:hover {
            background: #339af0;
        }

        /* Hide remove buttons initially */
        .remove-player.hidden {
            display: none;
        }

        /* Game Screens */
        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        /* Game Header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #16213e;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
        }

        .game-header-controls {
            display: flex;
            gap: 10px;
        }

        .settings-btn {
            background: #4dabf7;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            transform: scale(1.1);
        }

        /* 501 Game Layout */
        .scoreboard-501 {
            background: #0f3460;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .legs-set-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4dabf7;
        }

        .player-legs-set {
            text-align: center;
            min-width: 100px;
        }

        .player-legs-set-name {
            font-size: 1rem;
            color: #FFD700;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .legs-set-display {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .leg-set-item {
            text-align: center;
        }

        .leg-set-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .leg-set-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffffff;
        }

        .players-score-501 {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .player-column-501 {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .player-column-501.active {
            border: 3px solid #4dabf7;
            background: #1a3a6e;
        }

        .player-name-501 {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #FFD700;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .player-name-501:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .player-remaining-score {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
            color: #ffffff;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 3px solid #4dabf7;
        }

        .score-history {
            margin: 20px 0;
            width: 100%;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
        }

        .score-item {
            font-size: 1.3rem;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .score-item.bust {
            color: #ff6b6b;
        }

        .score-item.win {
            color: #20c997;
            font-weight: bold;
        }

        .score-input-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
        }

        .score-input-label {
            display: block;
            color: #4dabf7;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Remaining score display next to player name */
        .remaining-score-display {
            color: #FFFFFF;
            background: #0f3460;
            padding: 8px 18px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.4rem;
            margin-left: 15px;
            display: inline-block;
            min-width: 10px;
            text-align: center;
            border: 1px solid white;
        }

        .remaining-score-display.low {
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }

        .remaining-score-display.win {
            background: #20c997;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .quick-score-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-score-btn {
            padding: 12px;
            background: #0f3460;
            border: 2px solid #4dabf7;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-score-btn:hover {
            background: #1a3a6e;
        }

        .score-input {
            width: 100%;
            padding: 18px;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 8px;
            border: 2px solid #4dabf7;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 15px;
        }

        .add-score-btn {
            background: #20c997;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 8px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        /* Game Controls */
        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .undo-btn {
            background: #ff922b;
            color: white;
        }

        .next-player-btn {
            background: #4dabf7;
            color: white;
        }

        .new-game-btn {
            background: #ff6b6b;
            color: white;
        }

        /* Cricket Game Layout */
        .scoreboard-cricket {
            background: #0f3460;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .cricket-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .cricket-table th {
            background: #16213e;
            padding: 12px 8px;
            text-align: center;
            font-size: 1rem;
            border-bottom: 2px solid #4dabf7;
        }

        .cricket-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .number-cell {
            background: #16213e;
            font-weight: bold;
            font-size: 1.1rem;
            width: 60px;
        }

        .player-header-cell {
            background: #16213e;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .player-header-cell:hover {
            background: #1a3a6e;
        }

        .player-header-cell.active {
            background: #4dabf7;
            color: white;
        }

        .player-score-cell {
            font-size: 1.1rem;
            font-weight: bold;
            color: #FFD700;
        }

        .mark-cell {
            height: 50px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .mark-cell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mark-cell.active {
            background: rgba(77, 171, 247, 0.3);
        }

        .mark-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            height: 100%;
        }

        .mark {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .mark.filled {
            background: #20c997;
            color: white;
        }

        .mark.closed {
            background: #4dabf7;
            color: white;
        }

        .mark.x {
            font-size: 1rem;
            font-weight: bold;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: #16213e;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
        }

        .settings-title {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 25px;
            text-align: center;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 10px;
            color: #4dabf7;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .settings-input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4dabf7;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
        }

        .settings-btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .save-settings, .cancel-settings {
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            flex: 1;
            font-size: 1.1rem;
        }

        .save-settings {
            background: #20c997;
            color: white;
        }

        .cancel-settings {
            background: #6c757d;
            color: white;
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .config-screen {
                padding: 20px;
                margin: 15px auto;
            }
            
            .config-title {
                font-size: 1.8rem;
                margin-bottom: 20px;
            }
            
            .game-btn {
                padding: 18px;
                font-size: 1.2rem;
            }
            
            .player-input {
                padding: 12px;
                font-size: 1rem;
            }
            
            .players-score-501 {
                flex-direction: column;
                align-items: center;
            }
            
            .player-column-501 {
                width: 100%;
                max-width: none;
            }
            
            .game-controls {
                flex-direction: column;
            }
            
            .app-mode-toggle {
                width: 45px;
                height: 45px;
                top: 10px;
                right: 10px;
                font-size: 1.1rem;
            }
            
            .exit-app-mode-btn {
                top: 10px;
                left: 10px;
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .app-mode-notification {
                top: 10px;
                right: 10px;
                max-width: 250px;
                font-size: 12px;
                padding: 10px 16px;
            }
            
            /* Remaining score display mobile */
            .remaining-score-display {
                font-size: 1.3rem;
                padding: 6px 15px;
                margin-left: 10px;
                min-width: 70px;
            }
            
            /* Cricket mobile adjustments */
            .scoreboard-cricket {
                padding: 5px;
            }
            
            .cricket-table {
                min-width: 200px;
            }
            
            .mark-cell {
                height: 45px;
            }
            
            .mark {
                width: 16px;
                height: 16px;
                font-size: 0.7rem;
            }
            
            /* Fullscreen mode adjustments for mobile */
            .fullscreen-mode .scoreboard-501,
            .fullscreen-mode .scoreboard-cricket {
                padding: 10px !important;
            }
            
            .fullscreen-mode .player-column-501 {
                padding: 15px !important;
            }
        }

        @media (max-width: 480px) {
            .config-screen {
                padding: 15px;
            }
            
            .config-title {
                font-size: 1.6rem;
            }
            
            .game-btn {
                padding: 15px;
                font-size: 1.1rem;
            }
            
            .legs-set-container {
                flex-direction: column;
                align-items: center;
            }
            
            .player-legs-set {
                width: 100%;
                max-width: 200px;
            }
            
            .quick-score-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Remaining score display small mobile */
            .score-input-label {
                font-size: 1.1rem;
            }
            
            .remaining-score-display {
                font-size: 1.2rem;
                padding: 5px 12px;
                margin-left: 8px;
                min-width: 60px;
            }
            
            /* Cricket mobile adjustments */
            .cricket-table th,
            .cricket-table td {
                padding: 8px 5px;
            }
            
            .number-cell {
                width: 50px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- App Mode Toggle Button (always visible) -->
    <button class="app-mode-toggle" id="app-mode-toggle" title="Toggle app mode (fullscreen + screen lock)">
        <i class="fas fa-moon"></i>
    </button>
    
    <!-- Exit App Mode Button (only visible in app mode) -->
    <button class="exit-app-mode-btn" id="exit-app-mode-btn" title="Exit app mode">
        <i class="fas fa-times"></i> Exit App Mode
    </button>

    <div class="container">
        <!-- Configuration Screen -->
        <div class="config-screen" id="config-screen">
            <h1 class="config-title">Dart Score Tracker</h1>
            
            <div class="game-selection">
                <button class="game-btn selected" id="game-501-btn">
                    <i class="fas fa-bullseye"></i> 501 / 301
                </button>
                <button class="game-btn" id="game-cricket-btn">
                    <i class="fas fa-cricket"></i> Cricket
                </button>
            </div>
            
            <div class="player-config">
                <h3>Players</h3>
                <div class="player-inputs" id="player-inputs">
                    <div class="player-input-row">
                        <input type="text" class="player-input" placeholder="Player 1" value="Player1">
                        <button class="remove-player hidden">×</button>
                    </div>
                    <div class="player-input-row">
                        <input type="text" class="player-input" placeholder="Player 2" value="Player2">
                        <button class="remove-player hidden">×</button>
                    </div>
                </div>
                <button class="add-player" id="add-player">
                    <i class="fas fa-plus"></i> Add Player
                </button>
            </div>
            
            <button class="start-btn" id="start-game">
                <i class="fas fa-play"></i> Start Game
            </button>
        </div>

        <!-- 501 Game Screen -->
        <div class="game-screen" id="game-screen-501">
            <div class="game-header">
                <div class="game-title" id="game-title-501">501</div>
                <div class="game-header-controls">
                    <button class="settings-btn" id="settings-btn-501">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="scoreboard-501">
                <div class="legs-set-container" id="legs-set-container">
                    <!-- Player legs/sets will be dynamically added here -->
                </div>
                
                <div class="players-score-501" id="players-score-container">
                    <!-- Player columns will be dynamically added here -->
                </div>
                
                <div class="score-input-section">
                    <div class="score-input-label">
                        Current Player: <span id="current-player-name" style="color: #FFD700; font-weight: bold;">Player1</span>
                        <span class="remaining-score-display" id="remaining-score-display">501</span>
                    </div>
                                      
                    <input type="number" class="score-input" id="score-input-501" placeholder="Enter score" value="" min="0" max="180">
                    <button class="add-score-btn" id="add-score-501">
                        <i class="fas fa-plus"></i> Add Score
                    </button>
                </div>
            </div>
            
            <div class="game-controls">
                <button class="control-btn undo-btn" id="undo-501">
                    <i class="fas fa-undo"></i> Undo Last
                </button>
                <button class="control-btn next-player-btn" id="next-player-501">
                    <i class="fas fa-forward"></i> Skip Turn
                </button>
                <button class="control-btn new-game-btn" id="new-game-501">
                    <i class="fas fa-redo"></i> New Game
                </button>
            </div>
        </div>

        <!-- Cricket Game Screen -->
        <div class="game-screen" id="game-screen-cricket">
            <div class="game-header">
                <div class="game-title" id="game-title-cricket">Cricket</div>
                <div class="game-header-controls">
                    <button class="settings-btn" id="settings-btn-cricket">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="scoreboard-cricket">
                <table class="cricket-table">
                    <thead>
                        <tr>
                            <th></th>
                            <!-- Player headers will be added here -->
                        </tr>
                    </thead>
                    <tbody id="cricket-table-body">
                        <!-- Cricket table rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="game-controls">
                <button class="control-btn undo-btn" id="undo-cricket">
                    <i class="fas fa-undo"></i> Undo Last
                </button>
                <button class="control-btn new-game-btn" id="new-game-cricket">
                    <i class="fas fa-redo"></i> New Game
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <h2 class="settings-title">Game Settings</h2>
            
            <div class="settings-group">
                <label class="settings-label" for="starting-score">Starting Score</label>
                <select class="settings-input" id="starting-score">
                    <option value="501">501</option>
                    <option value="301">301</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label class="settings-label" for="legs-to-win-set">Legs to Win a Set</label>
                <input type="number" class="settings-input" id="legs-to-win-set" min="1" max="10" value="1">
            </div>
            
            <div class="settings-group">
                <label class="settings-label" for="sets-to-win-game">Sets to Win Game</label>
                <input type="number" class="settings-input" id="sets-to-win-game" min="1" max="10" value="1">
            </div>
            
            <div class="settings-btn-group">
                <button class="save-settings" id="save-settings">
                    <i class="fas fa-check"></i> Save
                </button>
                <button class="cancel-settings" id="cancel-settings">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            gameType: '501',
            players: [],
            currentPlayerIndex: 0,
            settings: {
                startingScore: 501,
                legsToWinSet: 1,
                setsToWinGame: 1
            },
            history: [],
            cricketState: {
                currentPlayerId: null,
                numbers: [20, 19, 18, 17, 16, 15, 25],
                closedNumbers: {}
            }
        };

        // App mode state
        let isAppModeActive = false;
        let wakeLock = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupConfiguration();
            setupEventListeners();
            setupAppMode();
            
            // Add visual feedback for button presses on mobile
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
            
            // Listen for fullscreen changes
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        });

        // Setup app mode functionality
        function setupAppMode() {
            const appModeToggle = document.getElementById('app-mode-toggle');
            const exitAppModeBtn = document.getElementById('exit-app-mode-btn');
            
            // Initial setup
            updateAppModeUI();
            
            // Event listeners
            appModeToggle.addEventListener('click', toggleAppMode);
            appModeToggle.addEventListener('touchstart', function(e) {
                e.preventDefault();
                toggleAppMode();
            });
            
            exitAppModeBtn.addEventListener('click', disableAppMode);
            exitAppModeBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                disableAppMode();
            });
            
            // Handle visibility change - reacquire wake lock if needed
            document.addEventListener('visibilitychange', async () => {
                if (isAppModeActive && document.visibilityState === 'visible') {
                    try {
                        await acquireWakeLock();
                    } catch (err) {
                        console.warn('Failed to reacquire wake lock:', err);
                    }
                }
            });
        }

        // Toggle app mode
        async function toggleAppMode() {
            if (isAppModeActive) {
                await disableAppMode();
            } else {
                await enableAppMode();
            }
        }

        // Enable app mode (fullscreen + wake lock)
        async function enableAppMode() {
            try {
                // Request fullscreen
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    await document.documentElement.webkitRequestFullscreen();
                }
                
                // Add fullscreen class to body
                document.body.classList.add('fullscreen-mode');
                
                // Request wake lock
                await acquireWakeLock();
                
                // Update state and UI
                isAppModeActive = true;
                updateAppModeUI();
                
                // Show notification
                showAppModeNotification('App mode activated - Fullscreen and screen lock prevention enabled', 'success');
                
            } catch (error) {
                console.error('Error enabling app mode:', error);
                showAppModeNotification('Failed to activate app mode', 'error');
            }
        }

        // Disable app mode
        async function disableAppMode() {
            try {
                // Exit fullscreen
                if (document.fullscreenElement && document.exitFullscreen) {
                    await document.exitFullscreen();
                } else if (document.webkitFullscreenElement && document.webkitExitFullscreen) {
                    await document.webkitExitFullscreen();
                }
                
                // Remove fullscreen class
                document.body.classList.remove('fullscreen-mode');
                
                // Release wake lock
                await releaseWakeLock();
                
                // Update state and UI
                isAppModeActive = false;
                updateAppModeUI();
                
                // Show notification
                showAppModeNotification('App mode disabled', 'info');
                
            } catch (error) {
                console.error('Error disabling app mode:', error);
            }
        }

        // Handle fullscreen change events
        function handleFullscreenChange() {
            const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            
            if (!isCurrentlyFullscreen && isAppModeActive) {
                // User manually exited fullscreen
                console.log('Manual exit from fullscreen detected');
                isAppModeActive = false;
                document.body.classList.remove('fullscreen-mode');
                
                // Also release wake lock
                if (wakeLock) {
                    wakeLock.release().then(() => {
                        wakeLock = null;
                        console.log('Wake lock released after exiting fullscreen');
                    });
                }
                
                updateAppModeUI();
                showAppModeNotification('App mode disabled', 'info');
            }
        }

        // Acquire wake lock
        async function acquireWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock acquired');
                    
                    // Add event listener for wake lock release
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake lock was released');
                        wakeLock = null;
                        
                        // If app mode is still active but wake lock was released, try to reacquire
                        if (isAppModeActive && document.visibilityState === 'visible') {
                            setTimeout(() => {
                                acquireWakeLock().catch(err => {
                                    console.error('Failed to reacquire wake lock:', err);
                                });
                            }, 1000);
                        }
                    });
                } else {
                    console.warn('Wake Lock API not supported');
                }
            } catch (err) {
                console.error('Failed to acquire wake lock:', err);
                throw err;
            }
        }

        // Release wake lock
        async function releaseWakeLock() {
            try {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('Wake lock released');
                }
            } catch (err) {
                console.error('Failed to release wake lock:', err);
            }
        }

        // Update app mode UI
        function updateAppModeUI() {
            const appModeToggle = document.getElementById('app-mode-toggle');
            
            if (isAppModeActive) {
                appModeToggle.classList.add('active');
                appModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                appModeToggle.title = 'App mode active - click to disable';
            } else {
                appModeToggle.classList.remove('active');
                appModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                appModeToggle.title = 'App mode disabled - click to enable';
            }
        }

        // Show app mode notification
        function showAppModeNotification(message, type = 'info') {
            // Remove existing notification
            const existingNotification = document.querySelector('.app-mode-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `app-mode-notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.style.display = 'block';
            }, 10);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }

        // Setup configuration screen
        function setupConfiguration() {
            // Game type selection
            const game501Btn = document.getElementById('game-501-btn');
            const gameCricketBtn = document.getElementById('game-cricket-btn');
            
            game501Btn.addEventListener('click', function() {
                game501Btn.classList.add('selected');
                gameCricketBtn.classList.remove('selected');
                gameState.gameType = '501';
            });
            
            gameCricketBtn.addEventListener('click', function() {
                gameCricketBtn.classList.add('selected');
                game501Btn.classList.remove('selected');
                gameState.gameType = 'cricket';
            });
            
            // Add player button
            document.getElementById('add-player').addEventListener('click', function() {
                const playerInputs = document.getElementById('player-inputs');
                const playerCount = playerInputs.children.length + 1;
                
                const playerRow = document.createElement('div');
                playerRow.className = 'player-input-row';
                playerRow.innerHTML = `
                    <input type="text" class="player-input" placeholder="Player ${playerCount}" value="Player${playerCount}">
                    <button class="remove-player">×</button>
                `;
                
                playerInputs.appendChild(playerRow);
                
                // Show remove buttons for all rows if more than 2 players
                if (playerInputs.children.length > 2) {
                    document.querySelectorAll('.remove-player').forEach(btn => {
                        btn.classList.remove('hidden');
                    });
                }
            });
            
            // Remove player event delegation
            document.getElementById('player-inputs').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-player')) {
                    const playerRow = e.target.parentElement;
                    playerRow.remove();
                    
                    // Hide remove buttons if only 2 players left
                    if (document.querySelectorAll('.player-input-row').length <= 2) {
                        document.querySelectorAll('.remove-player').forEach(btn => {
                            btn.classList.add('hidden');
                        });
                    }
                }
            });
            
            // Start game button
            document.getElementById('start-game').addEventListener('click', startGame);
        }

        // Start the game
        function startGame() {
            // Get player names
            const playerInputs = document.querySelectorAll('.player-input');
            gameState.players = [];
            
            playerInputs.forEach((input, index) => {
                const playerName = input.value || `Player${index + 1}`;
                const startingScore = gameState.gameType === 'cricket' ? 0 : gameState.settings.startingScore;
                
                gameState.players.push({
                    id: index + 1,
                    name: playerName,
                    score: startingScore,
                    history: [],
                    legs: 0,
                    sets: 0,
                    cricketMarks: {
                        20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, 25: 0
                    },
                    cricketPoints: 0,
                    currentRoundScore: 0,
                    dartsThisRound: 0
                });
            });
            
            // Reset game state
            gameState.currentPlayerIndex = 0;
            gameState.history = [];
            gameState.cricketState.currentPlayerId = gameState.players[0]?.id || null;
            gameState.cricketState.closedNumbers = {};
            
            // Hide config screen
            document.getElementById('config-screen').classList.add('hidden');
            
            // Show appropriate game screen
            if (gameState.gameType === 'cricket') {
                document.getElementById('game-screen-501').classList.remove('active');
                document.getElementById('game-screen-cricket').classList.add('active');
                setupCricketGame();
            } else {
                document.getElementById('game-screen-cricket').classList.remove('active');
                document.getElementById('game-screen-501').classList.add('active');
                setup501Game();
            }
        }

        // Setup 501 game
        function setup501Game() {
            const gameTitle = document.getElementById('game-title-501');
            gameTitle.textContent = gameState.settings.startingScore;
            
            // Update legs/sets display
            const legsSetContainer = document.getElementById('legs-set-container');
            legsSetContainer.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerLegSet = document.createElement('div');
                playerLegSet.className = 'player-legs-set';
                playerLegSet.innerHTML = `
                    <div class="player-legs-set-name">${player.name}</div>
                    <div class="legs-set-display">
                        <div class="leg-set-item">
                            <div class="leg-set-label">Leg:</div>
                            <div class="leg-set-value">${player.legs}</div>
                        </div>
                        <div class="leg-set-item">
                            <div class="leg-set-label">Set:</div>
                            <div class="leg-set-value">${player.sets}</div>
                        </div>
                    </div>
                `;
                legsSetContainer.appendChild(playerLegSet);
            });
            
            // Update player columns
            const playersContainer = document.getElementById('players-score-container');
            playersContainer.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerColumn = document.createElement('div');
                playerColumn.className = `player-column-501 ${index === gameState.currentPlayerIndex ? 'active' : ''}`;
                playerColumn.id = `player-column-${player.id}`;
                
                // Create player name (clickable to select)
                const playerName = document.createElement('div');
                playerName.className = 'player-name-501';
                playerName.textContent = player.name;
                playerName.addEventListener('click', () => selectPlayer501(player.id));
                playerName.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    selectPlayer501(player.id);
                });
                
                // Create remaining score display
                const remainingScore = document.createElement('div');
                remainingScore.className = 'player-remaining-score';
                remainingScore.id = `player-score-${player.id}`;
                remainingScore.textContent = player.score;
                
                // Create history display
                const historyElement = document.createElement('div');
                historyElement.className = 'score-history';
                historyElement.id = `player-history-${player.id}`;
                
                // Add previous scores (last 5)
                player.history.slice(-5).forEach(score => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    if (typeof score === 'string' && score.includes('BUST')) {
                        scoreItem.textContent = score;
                        scoreItem.classList.add('bust');
                    } else if (typeof score === 'string' && score.includes('WIN')) {
                        scoreItem.textContent = score;
                        scoreItem.classList.add('win');
                    } else {
                        scoreItem.textContent = score;
                    }
                    
                    historyElement.appendChild(scoreItem);
                });
                
                playerColumn.appendChild(playerName);
                playerColumn.appendChild(remainingScore);
                playerColumn.appendChild(historyElement);
                playersContainer.appendChild(playerColumn);
            });
            
            // Update current player display
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            document.getElementById('current-player-name').textContent = currentPlayer.name;
            
            // Update the remaining score display next to player name
            updateRemainingScoreDisplay();
            
            // Focus on score input
            document.getElementById('score-input-501').focus();
        }

        // Update the remaining score display
        function updateRemainingScoreDisplay() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const display = document.getElementById('remaining-score-display');
            
            if (currentPlayer && display) {
                display.textContent = currentPlayer.score;
                
                // Add visual effects based on score
                display.classList.remove('low', 'win');
                
                if (currentPlayer.score <= 40) {
                    // Low score warning (for potential finish)
                    display.classList.add('low');
                }
                
                if (currentPlayer.score === 0) {
                    // Win condition
                    display.classList.add('win');
                }
            }
        }

        // Select player in 501 game
        function selectPlayer501(playerId) {
            const playerIndex = gameState.players.findIndex(p => p.id === playerId);
            if (playerIndex !== -1) {
                gameState.currentPlayerIndex = playerIndex;
                setup501Game();
            }
        }

        // Add score in 501 game
        function addScore501() {
            const scoreInput = document.getElementById('score-input-501');
            const score = parseInt(scoreInput.value) || 0;
            
            if (score < 0 || score > 180) {
                alert('Please enter a score between 0 and 180');
                return;
            }
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const newScore = currentPlayer.score - score;
            
            // Track this dart
            currentPlayer.dartsThisRound++;
            currentPlayer.currentRoundScore += score;
            
            // Turn after each score input
            if (currentPlayer.dartsThisRound >= 1) {
                // End of turn - process the score
                processTurnEnd501(currentPlayer, newScore);
                currentPlayer.dartsThisRound = 0;
                currentPlayer.currentRoundScore = 0;
                
                // Move to next player
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            } else {
                // Still within turn, just update display
                currentPlayer.history.push(score);
            }
            
            // Add to history
            gameState.history.push({
                playerId: currentPlayer.id,
                action: 'score',
                value: score,
                roundScore: currentPlayer.currentRoundScore,
                darts: currentPlayer.dartsThisRound,
                timestamp: new Date().getTime()
            });
            
            // Update display
            setup501Game();
            
            // Update the remaining score display
            updateRemainingScoreDisplay();
            
            // Reset input
            scoreInput.value = '';
            scoreInput.focus();
        }

        // Process end of turn in 501
        function processTurnEnd501(player, newScore) {
            const turnScore = player.currentRoundScore;
            
            // Check if game is finished
            if (newScore === 0) {
                // Check if last dart was a double or bullseye
                const lastDartWasDouble = confirm(`${player.name} finished with ${turnScore} points. Was the last dart a double or bullseye? (OK for Yes, Cancel for No)`);
                
                if (lastDartWasDouble) {
                    // Player wins the leg
                    player.legs++;
                    player.history.push(`WIN! (${turnScore})`);
                    
                    // Check if player wins the set
                    if (player.legs >= gameState.settings.legsToWinSet) {
                        player.sets++;
                        player.legs = 0;
                        
                        // Check if player wins the game
                        if (player.sets >= gameState.settings.setsToWinGame) {
                            alert(`${player.name} wins the game!`);
                            resetGame();
                            return;
                        } else {
                            alert(`${player.name} wins the set! Starting new set.`);
                            // Reset scores for new set
                            gameState.players.forEach(p => {
                                p.score = gameState.settings.startingScore;
                                p.history = [];
                            });
                        }
                    } else {
                        alert(`${player.name} wins the leg!`);
                        // Reset scores for new leg
                        gameState.players.forEach(p => {
                            p.score = gameState.settings.startingScore;
                            p.history = [];
                        });
                    }
                } else {
                    // Bust - score stays the same
                    player.history.push(`BUST (${turnScore})`);
                }
            } else if (newScore < 0 || newScore === 1) {
                // Bust - score stays the same
                player.history.push(`BUST (${turnScore})`);
            } else {
                // Valid score
                player.score = newScore;
                player.history.push(turnScore);
            }
        }

        // Skip turn in 501
        function nextPlayer501() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Reset current round if there were partial darts
            if (currentPlayer.dartsThisRound > 0) {
                currentPlayer.dartsThisRound = 0;
                currentPlayer.currentRoundScore = 0;
            }
            
            // Move to next player
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            
            // Update display
            setup501Game();
            
            // Update the remaining score display
            updateRemainingScoreDisplay();
        }

        // Setup cricket game
        function setupCricketGame() {
            const tableBody = document.getElementById('cricket-table-body');
            tableBody.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            const emptyHeader = document.createElement('th');
            emptyHeader.textContent = '';
            headerRow.appendChild(emptyHeader);
            
            gameState.players.forEach(player => {
                const th = document.createElement('th');
                th.className = `player-header-cell ${player.id === gameState.cricketState.currentPlayerId ? 'active' : ''}`;
                th.textContent = player.name;
                th.dataset.playerId = player.id;
                
                th.addEventListener('click', function() {
                    selectCricketPlayer(player.id);
                });
                th.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    selectCricketPlayer(player.id);
                });
                
                headerRow.appendChild(th);
            });
            
            tableBody.appendChild(headerRow);
            
            // Add points row
            const pointsRow = document.createElement('tr');
            const pointsLabel = document.createElement('td');
            pointsLabel.className = 'number-cell';
            pointsLabel.textContent = 'Pts';
            pointsRow.appendChild(pointsLabel);
            
            gameState.players.forEach(player => {
                const td = document.createElement('td');
                td.className = 'player-score-cell';
                td.textContent = player.cricketPoints;
                pointsRow.appendChild(td);
            });
            
            tableBody.appendChild(pointsRow);
            
            // Add number rows (20 to 15, then 25 for bull)
            gameState.cricketState.numbers.forEach(number => {
                const row = document.createElement('tr');
                
                // Number cell
                const numberCell = document.createElement('td');
                numberCell.className = 'number-cell';
                numberCell.textContent = number === 25 ? 'Bull' : number;
                row.appendChild(numberCell);
                
                // Player cells
                gameState.players.forEach(player => {
                    const td = document.createElement('td');
                    td.className = 'mark-cell';
                    td.dataset.playerId = player.id;
                    td.dataset.number = number;
                    
                    const marks = player.cricketMarks[number] || 0;
                    
                    const markDisplay = document.createElement('div');
                    markDisplay.className = 'mark-display';
                    
                    // Show marks
                    if (marks >= 3) {
                        // Closed - show XXX
                        for (let i = 0; i < 3; i++) {
                            const mark = document.createElement('div');
                            mark.className = 'mark filled closed x';
                            mark.textContent = 'X';
                            markDisplay.appendChild(mark);
                        }
                    } else {
                        // Not closed - show individual marks
                        for (let i = 0; i < 3; i++) {
                            const mark = document.createElement('div');
                            mark.className = 'mark';
                            if (i < marks) {
                                mark.classList.add('filled');
                                mark.textContent = 'X';
                            }
                            markDisplay.appendChild(mark);
                        }
                    }
                    
                    td.appendChild(markDisplay);
                    
                    // Add click event
                    td.addEventListener('click', function() {
                        if (gameState.cricketState.currentPlayerId === player.id) {
                            addCricketMark(player.id, number);
                        }
                    });
                    td.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        if (gameState.cricketState.currentPlayerId === player.id) {
                            addCricketMark(player.id, number);
                        }
                    });
                    
                    row.appendChild(td);
                });
                
                tableBody.appendChild(row);
            });
        }

        // Select cricket player
        function selectCricketPlayer(playerId) {
            gameState.cricketState.currentPlayerId = playerId;
            setupCricketGame();
        }

        // Add mark in cricket game
        function addCricketMark(playerId, number) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            
            // Check if player has already closed this number (3 marks)
            const hasClosedNumber = player.cricketMarks[number] >= 3;
            
            if (hasClosedNumber) {
                // Player has already closed this number
                // Give points to all players who haven't closed this number
                gameState.players.forEach(otherPlayer => {
                    if (otherPlayer.id !== playerId && otherPlayer.cricketMarks[number] < 3) {
                        // Other player hasn't closed this number - they get points
                        const pointsToAdd = (number === 25 ? 25 : number);
                        otherPlayer.cricketPoints += pointsToAdd;
                        
                        // Add to history
                        gameState.history.push({
                            playerId: otherPlayer.id,
                            action: 'cricket-points-received',
                            fromPlayer: playerId,
                            number: number,
                            points: pointsToAdd,
                            timestamp: new Date().getTime()
                        });
                    }
                });
                
                // Add to history
                gameState.history.push({
                    playerId: playerId,
                    action: 'cricket-hit-closed',
                    number: number,
                    timestamp: new Date().getTime()
                });
            } else {
                // Player hasn't closed this number yet - add a mark
                player.cricketMarks[number]++;
                
                // Check if this mark closes the number (reaches 3 marks)
                if (player.cricketMarks[number] === 3) {
                    // Player just closed this number
                    gameState.cricketState.closedNumbers[number] = playerId;
                    
                    // Add to history
                    gameState.history.push({
                        playerId: playerId,
                        action: 'cricket-close',
                        number: number,
                        timestamp: new Date().getTime()
                    });
                };
                
                // Add to history
                gameState.history.push({
                    playerId: playerId,
                    action: 'cricket-mark',
                    number: number,
                    marks: player.cricketMarks[number],
                    timestamp: new Date().getTime()
                });
            }
            
            // Update display
            setupCricketGame();
            
            // Check for win condition
            checkCricketWin();
        }

        // Check cricket win condition
        function checkCricketWin() {
            // A player wins if they have closed all numbers AND have equal or LOWER points than all opponents
            gameState.players.forEach(player => {
                let allClosed = true;
                gameState.cricketState.numbers.forEach(number => {
                    if (player.cricketMarks[number] < 3) {
                        allClosed = false;
                    }
                });
                
                if (allClosed) {
                    // Player has closed all numbers
                    // Check if they have equal or LOWER points than all opponents
                    let hasLowestScore = true;
                    gameState.players.forEach(otherPlayer => {
                        if (otherPlayer.id !== player.id && player.cricketPoints > otherPlayer.cricketPoints) {
                            hasLowestScore = false;
                        }
                    });
                    
                    if (hasLowestScore) {
                        setTimeout(() => {
                            alert(`${player.name} wins the cricket game!`);
                            resetGame();
                        }, 500);
                    }
                }
            });
        }

        // Undo last action
        function undoLast() {
            if (gameState.history.length === 0) return;
            
            const lastAction = gameState.history.pop();
            
            if (gameState.gameType === '501') {
                // Undo 501 score
                const player = gameState.players.find(p => p.id === lastAction.playerId);
                if (player && lastAction.action === 'score') {
                    // Remove from history
                    if (player.history.length > 0) {
                        player.history.pop();
                    }
                    
                    // Adjust darts count and current round score
                    if (player.dartsThisRound > 0) {
                        player.dartsThisRound--;
                        player.currentRoundScore -= lastAction.value;
                    }
                    
                    // Go back to previous player if this was the start of a new turn
                    if (lastAction.darts === 1) {
                        gameState.currentPlayerIndex = (gameState.currentPlayerIndex - 1 + gameState.players.length) % gameState.players.length;
                    }
                    
                    setup501Game();
                }
            } else if (gameState.gameType === 'cricket') {
                // For cricket, we need to revert based on the action type
                const player = gameState.players.find(p => p.id === lastAction.playerId);
                if (player) {
                    switch (lastAction.action) {
                        case 'cricket-mark':
                            // Remove the mark
                            if (player.cricketMarks[lastAction.number] > 0) {
                                player.cricketMarks[lastAction.number]--;
                                
                                // If this was the 3rd mark, remove from closed numbers
                                if (player.cricketMarks[lastAction.number] === 2) {
                                    delete gameState.cricketState.closedNumbers[lastAction.number];
                                }
                            }
                            break;
                            
                        case 'cricket-close':
                            // Revert closing
                            player.cricketMarks[lastAction.number] = 2;
                            delete gameState.cricketState.closedNumbers[lastAction.number];
                            break;
                            
                        case 'cricket-points-received':
                            // Remove points from the player who received them
                            const receiver = gameState.players.find(p => p.id === lastAction.playerId);
                            if (receiver) {
                                receiver.cricketPoints -= lastAction.points;
                            }
                            break;
                            
                        case 'cricket-points-from-hit':
                            // Remove points from the player who earned them
                            const earner = gameState.players.find(p => p.id === lastAction.playerId);
                            if (earner) {
                                earner.cricketPoints -= lastAction.points;
                            }
                            break;
                    }
                    
                    setupCricketGame();
                }
            }
        }

        // Reset game
        function resetGame() {
            gameState.players = [];
            gameState.history = [];
            gameState.currentPlayerIndex = 0;
            gameState.cricketState.closedNumbers = {};
            
            document.getElementById('game-screen-501').classList.remove('active');
            document.getElementById('game-screen-cricket').classList.remove('active');
            document.getElementById('config-screen').classList.remove('hidden');
        }

        // Settings modal
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            
            // Load current settings
            document.getElementById('starting-score').value = gameState.settings.startingScore;
            document.getElementById('legs-to-win-set').value = gameState.settings.legsToWinSet;
            document.getElementById('sets-to-win-game').value = gameState.settings.setsToWinGame;
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            gameState.settings.startingScore = parseInt(document.getElementById('starting-score').value);
            gameState.settings.legsToWinSet = parseInt(document.getElementById('legs-to-win-set').value);
            gameState.settings.setsToWinGame = parseInt(document.getElementById('sets-to-win-game').value);
            
            // Update game title if 501 game is active
            if (gameState.gameType === '501') {
                document.getElementById('game-title-501').textContent = gameState.settings.startingScore;
                
                // Also update player scores if game is in progress
                if (gameState.players.length > 0) {
                    const isNewSet = confirm("Changing settings will reset the current game. Continue?");
                    if (isNewSet) {
                        resetGame();
                    } else {
                        closeSettings();
                        return;
                    }
                }
            }
            
            closeSettings();
            startGame();
        }

        // Setup event listeners
        function setupEventListeners() {
            // 501 game events
            document.getElementById('add-score-501').addEventListener('click', addScore501);
            document.getElementById('score-input-501').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addScore501();
                }
            });
            
            // Quick score buttons
            document.querySelectorAll('.quick-score-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const score = parseInt(this.dataset.score);
                    document.getElementById('score-input-501').value = score;
                    addScore501();
                });
            });
            
            document.getElementById('undo-501').addEventListener('click', undoLast);
            document.getElementById('next-player-501').addEventListener('click', nextPlayer501);
            document.getElementById('new-game-501').addEventListener('click', resetGame);
            document.getElementById('settings-btn-501').addEventListener('click', openSettings);
            
            // Cricket game events
            document.getElementById('undo-cricket').addEventListener('click', undoLast);
            document.getElementById('new-game-cricket').addEventListener('click', resetGame);
            document.getElementById('settings-btn-cricket').addEventListener('click', openSettings);
            
            // Settings modal events
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('cancel-settings').addEventListener('click', closeSettings);
            
            // Close modal when clicking outside
            document.getElementById('settings-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        }
    </script>
</body>
</html>